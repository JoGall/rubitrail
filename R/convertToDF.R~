#' @include basic.R
#' @include main.R
NULL
#' Flattens rubitrail lists into a single dataframe.
#'
#' A helper function which flattens a list, or a list of lists, returned by \code{\link{rubitBasic}} and \code{\link{rubitMain}} and converts into a dataframe for ease of further analysis.
#' 
#' @param l a list (single result file) or list of lists (multiple results files) returned by \code{\link{rubitBasic}} or \code{\link{rubitMain}}.
#' @param type the type of data contained in \code{l}; \code{basic} for data returned by \code{\link{rubitBasic}} and \code{main} for data returned by \code{\link{rubitMain}}.
#' @return A single dataframe for 'basic' input data. A list of three dataframes for 'main' input data, with elements named 'speeds', 'turning' and 'activity'.
#' @examples
#' data(tenebrio)
#' ### 
#' rubitDF(tenebrio, "basic")
#'
#' rubitDF(tenebrio, "main")
#'
#' @seealso \code{\link{rubitBasic}} and \code{\link{rubitMain}} for information on processing and analysing tracking data.
#' @export
rubitDF <- function(l, type = c("basic", "main")) {
	
	#data returned by rubitBasic  (i.e. one dataset for each area matrix)
	if(type=="basic") {
		# Single list (one result file)
		if(class(l[[1]]) == "matrix") {
			filename <- attributes(l)$filename
			areas <- names(l)
			
			l_df <- data.frame()
			for(i in unique(areas)){
				ss_df <- as.data.frame(l[[i]])
				ss_df$filename <- rep(filename, nrow(ss_df))
				ss_df$area <- rep(i, nrow(ss_df))
				l_df <- rbind(l_df, ss_df)
			}
			return(l_df)		
		}
		# List of lists (multiple results files)
		else {
			ll_df <- data.frame()
			#loop for list of lists
			for(j in 1:length(l)) {
				filename <- attributes(l[[j]])$filename
				areas <- names(l[[j]])
				l_df <- data.frame()
				for(i in unique(areas)){
					ss_df <- as.data.frame(l[[j]][[i]])
					ss_df$filename <- rep(filename, nrow(ss_df))
					ss_df$area <- rep(i, nrow(ss_df))
					l_df <- rbind(l_df, ss_df)
				}
				ll_df <- rbind(ll_df, l_df)
			}
			return(ll_df)
		}
	}
	
	#data returned by rubitMain  (i.e. three datasets for each area matrix: 'speeds', 'turning' and 'activity')
	if(type=="main") {
	
		# Single list (one result file)
		if(class(l[["speeds"]][[1]]) == "matrix") {
			filename <- attributes(l[["speeds"]])$filename
			areas <- names(l[["speeds"]])
			
			#speed data
			l_speed <- data.frame()
			for(i in unique(areas)){
				ss_speed <- as.data.frame(l[["speeds"]][[i]])
				ss_speed$filename <- rep(filename, nrow(ss_speed))
				ss_speed$area <- rep(i, nrow(ss_speed))
				l_speed <- rbind(l_speed, ss_speed)
			}
			#turning data
			l_turning <- data.frame()
			for(i in unique(areas)){
				ss_turning <- as.data.frame(l[["turning"]][[i]])
				ss_turning$filename <- rep(filename, nrow(ss_turning))
				ss_turning$area <- rep(i, nrow(ss_turning))
				l_turning <- rbind(l_turning, ss_turning)
			}
			#activity data
			l_activity <- data.frame()
			for(i in unique(areas)){
				ss_activity <- as.data.frame(l[["activity"]][[i]])
				ss_activity$filename <- rep(filename, nrow(ss_activity))
				ss_activity$area <- rep(i, nrow(ss_activity))
				l_activity <- rbind(l_activity, ss_activity)
			}
			return(list(speed = l_speed, turning = l_turning, activity = l_activity))
		}
		
		# List of lists (multiple results files)
		if(class(l[[1]][["speeds"]][[1]]) == "matrix") {
			ll_speed <- data.frame()
			ll_turning <- data.frame()
			ll_activity <- data.frame()
			
			#loop for three datasets
			
			#loop for list of lists
			for(j in 1:length(l)) {
				filename <- attributes(l[[j]][["speeds"]])$filename
				areas <- names(l[[j]][["speeds"]])
				ll_speed <- data.frame()
				ll_turning <- data.frame()
				ll_activity <- data.frame()
				
				for(i in unique(areas)){
					ss_speed <- as.data.frame(l[[j]][["speeds"]][[i]])
					ss_speed$filename <- rep(filename, nrow(ss_speed))
					ss_speed$area <- rep(i, nrow(ss_speed))
					l_speed <- rbind(l_speed, ss_speed)
				
					ss_turning <- as.data.frame(l[[j]][["turning"]][[i]])
					ss_turning$filename <- rep(filename, nrow(ss_turning))
					ss_turning$area <- rep(i, nrow(ss_turning))
					l_turning <- rbind(l_turning, ss_turning)
				
					ss_activity <- as.data.frame(l[[j]][["activity"]][[i]])
					ss_activity$filename <- rep(filename, nrow(ss_activity))
					ss_activity$area <- rep(i, nrow(ss_activity))
					l_activity <- rbind(l_activity, ss_activity)
				}
				ll_speed <- rbind(ll_speed, l_speed)
				ll_turning <- rbind(ll_turning, l_turning)
				ll_activity <- rbind(ll_activity, l_activity)
			}
			return(list(speed = ll_speed, turning = ll_turning, activity = ll_activity))
		}
	}
}